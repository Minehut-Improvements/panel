<div class="flex justify-between items-center mb-6">
    <h3 class="text-2xl font-bold">Server Properties</h3>
    <button onclick="resetProps()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
        Reset server.properties
    </button>
</div>

<select id="edit-mode" class="w-full p-3 mb-6 bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg text-white">
    <option value="edit">Full Edit Mode</option>
    <option value="patch">Limited Patch Mode</option>
</select>

<form id="properties-form" class="grid grid-cols-1 md:grid-cols-2 gap-6"></form>

<script>
let serverProperties = {};

async function loadProperties() {
    try {
        const response = await axios.get(`/proxy/file/${serverId}/read/server.properties`);
        const content = response.data.content;
        serverProperties = Object.fromEntries(
            content.split('\n')
                .filter(line => line && !line.startsWith('#'))
                .map(line => {
                    const [key, value] = line.split('=').map(part => part.trim());
                    return [key, isNaN(value) ? 
                        value === 'true' ? true : 
                        value === 'false' ? false : 
                        value : Number(value)];
                })
        );
        renderPropertiesForm();
    } catch (error) {
        console.error('Failed to fetch properties:', error);
    }
}

function renderPropertiesForm() {
    const form = document.getElementById('properties-form');
    const editMode = document.getElementById('edit-mode').value;
    form.innerHTML = '';

    const fields = getFields(editMode);
    fields.forEach(field => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = createFieldHTML(field);
        form.appendChild(div);
    });
    
    const submitBtn = document.createElement('button');
    submitBtn.className = 'col-span-1 md:col-span-2 mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105';
    submitBtn.textContent = 'Save Properties';
    submitBtn.onclick = submitProperties;
    form.appendChild(submitBtn);
}

document.getElementById('edit-mode').onchange = renderPropertiesForm;

function createFieldHTML(field) {
    const label = field.name.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
    const baseInputClass = "w-full p-3 bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white";
    
    if (field.type === 'boolean') {
        return `
            <label class="relative flex items-center justify-between p-4 bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg group hover:border-blue-500 transition-colors duration-200">
                <span class="text-white">${label}</span>
                <div class="relative">
                    <input type="checkbox" name="${field.name}" 
                        ${serverProperties[field.name] ? 'checked' : ''}
                        class="peer sr-only">
                    <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-blue-500 peer-focus:ring-2 peer-focus:ring-blue-500"></div>
                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all duration-200 peer-checked:translate-x-5"></div>
                </div>
            </label>
        `;
    }
    
    if (field.type === 'select') {
        const options = field.name === 'gamemode' ? 
            ['survival', 'creative', 'adventure', 'spectator'] :
            ['peaceful', 'easy', 'normal', 'hard'];
        
        return `
            <div class="space-y-2">
                <label class="block font-medium text-white">${label}</label>
                <select name="${field.name}" class="${baseInputClass}">
                    ${options.map(opt => `
                        <option value="${opt}" ${serverProperties[field.name] === opt ? 'selected' : ''}>
                            ${opt.charAt(0).toUpperCase() + opt.slice(1)}
                        </option>
                    `).join('')}
                </select>
            </div>
        `;
    }
    
    return `
        <div class="space-y-2">
            <label class="block font-medium text-white">${label}</label>
            <input type="${field.type}" name="${field.name}" 
                value="${serverProperties[field.name] || ''}"
                class="${baseInputClass}">
        </div>
    `;
}

function getFields(editMode) {
    return editMode === 'edit' ? [
        { name: 'max-players', type: 'number' },
        { name: 'view-distance', type: 'number' },
        { name: 'gamemode', type: 'select' },
        { name: 'difficulty', type: 'select' },
        { name: 'spawn-monsters', type: 'boolean' },
        { name: 'spawn-animals', type: 'boolean' },
        { name: 'force-gamemode', type: 'boolean' },
        { name: 'level-type', type: 'text' },
        { name: 'spawn-npcs', type: 'boolean' },
        { name: 'allow-nether', type: 'boolean' },
        { name: 'pvp', type: 'boolean' },
        { name: 'allow-flight', type: 'boolean' },
        { name: 'spawn-protection', type: 'number' },
        { name: 'announce-player-achievements', type: 'boolean' },
        { name: 'enable-command-block', type: 'boolean' },
        { name: 'require-resource-pack', type: 'boolean' },
        { name: 'hardcore', type: 'boolean' },
        { name: 'level-name', type: 'text' },
        { name: 'max-tick-time', type: 'number' },
        { name: 'resource-pack-prompt', type: 'text' },
        { name: 'op-permission-level', type: 'number' },
        { name: 'entity-broadcast-range-percentage', type: 'number' },
        { name: 'white-list', type: 'boolean' },
        { name: 'snooper-enabled', type: 'boolean' },
        { name: 'enforce-whitelist', type: 'boolean' }
    ] : [
        { name: 'max-players', type: 'number' },
        { name: 'pvp', type: 'boolean' },
        { name: 'enable-command-block', type: 'boolean' },
        { name: 'allow-nether', type: 'boolean' },
        { name: 'white-list', type: 'boolean' },
        { name: 'enforce-whitelist', type: 'boolean' },
        { name: 'player-idle-timeout', type: 'number' },
        { name: 'allow-flight', type: 'boolean' },
        { name: 'spawn-protection', type: 'number' },
        { name: 'view-distance', type: 'number' },
        { name: 'simulation-distance', type: 'number' },
        { name: 'entity-broadcast-range-percentage', type: 'number' },
        { name: 'broadcast-console-to-ops', type: 'boolean' },
        { name: 'op-permission-level', type: 'number' },
        { name: 'function-permission-level', type: 'number' }
    ];
}

async function submitProperties(e) {
    e.preventDefault();
    const form = document.getElementById('properties-form');
    const editMode = document.getElementById('edit-mode').value;
    const formData = new FormData(form);
    const properties = {};

    formData.forEach((value, key) => {
        properties[key] = value === 'on' ? true : 
                         value === 'off' ? false :
                         !isNaN(value) ? Number(value) : value;
    });

    try {
        await axios({
            method: editMode === 'edit' ? 'POST' : 'PATCH',
            url: `/proxy/server/${serverId}/${editMode === 'edit' ? 'edit' : 'patch'}_server_properties`,
            data: { serverProperties: properties }
        });
        restartServer();
        alert('Properties updated successfully');
    } catch (error) {
        alert('Failed to update properties');
        console.error(error);
    }
}

loadProperties();
</script>